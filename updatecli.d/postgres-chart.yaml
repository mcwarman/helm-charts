name: PostgreSQL Chart

sources:
  latestRelease:
    name: Get latest bitnami/postgresql chart
    kind: helmchart
    spec:
      url: https://charts.bitnami.com/bitnami/
      name: postgresql

conditions:
  ensureDependenciesOrderName:
    name: Ensure dependencies order - check name
    disablesourceinput: true
    kind: yaml
    spec:
      file: charts/backstage/Chart.yaml
      key: $.dependencies[0].name
      value: postgresql
  ensureDependenciesOrderRepository:
    name: Ensure dependencies order - check repository
    disablesourceinput: true
    kind: yaml
    spec:
      file: charts/backstage/Chart.yaml
      key: $.dependencies[0].repository
      value: https://charts.bitnami.com/bitnami/

targets:
  chart:
    name: 'Bump bitnami/postgresql chart version to to {{ source "latestRelease" }}'
    kind: helmchart
    scmid: default
    spec:
      name: charts/backstage
      file: Chart.yaml
      key: $.dependencies[0].version
      versionincrement: auto
  readme:
    name: Update chart helm-docs
    kind: shell
    scmid: default
    disablesourceinput: true
    spec:
      command: make docs
      environments:
        - name: PATH
    dependson:
      - chart

scms:
  default:
    kind: github
    spec:
      owner: mcwarman
      repository: helm-charts
      branch: main
      user: '{{ requiredEnv "GITHUB_USERNAME" }}'
      email: '{{ requiredEnv "GITHUB_EMAIL" }}'
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      username: '{{ requiredEnv "GITHUB_USERNAME" }}'
      commitmessage:
        type: build
        scope: deps
        title: 'bump bitnami/postgresql chart version to {{ source "latestRelease" }}'
        hidecredit: true
    disabled: false

actions:
  default:
    title: 'build(deps): bump bitnami/postgresql chart version to {{ source "latestRelease" }}'
    kind: github/pullrequest
    spec:
      mergemethod: squash
      labels:
        - dependencies
    scmid: default
